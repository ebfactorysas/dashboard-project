/**
 * Start code-trend
 *  */

codetrendArrays = {
    codeTrendIADBAllTime: [
        {
            "name": "Hydro-BID",
            "value": 461
        },
        {
            "name": "Indicator aggregator",
            "value": 3881
        },
        {
            "name": "MapMap",
            "value": 3633
        },
        {
            "name": "Evaluación de Reciclaje Inclusivo",
            "value": 3280
        },
        {
            "name": "Consul",
            "value": 2726
        },
        {
            "name": "SmartMap",
            "value": 1120
        },
        {
            "name": "SIMPLE-LAT",
            "value": 1105
        },
        {
            "name": "Nexso",
            "value": 1051
        },
        {
            "name": "R Library Numbers for Development",
            "value": 875
        },
        {
            "name": "Tabula",
            "value": 861
        }
    ],
    codeTrendIADBA2018: [
        {
            "name": "Gobierto",
            "value": 801
        },
        {
            "name": "Gmapsdistance",
            "value": 531
        },
        {
            "name": "Massive change detection",
            "value": 495
        },
        {
            "name": "Clasificador de Datos Atípicos",
            "value": 376
        },
        {
            "name": "AP-LATAM",
            "value": 350
        },
        {
            "name": "AEDES Detector",
            "value": 0
        },
        {
            "name": "Consul",
            "value": 0
        },
        {
            "name": "Evaluación de Reciclaje Inclusivo",
            "value": 0
        },
        {
            "name": "Hydro-BID",
            "value": 0
        },
        {
            "name": "IDBx Data Engine",
            "value": 0
        },
        {
            "name": "Indicator aggregator",
            "value": 0
        },
        {
            "name": "MapMap",
            "value": 0
        },
        {
            "name": "Nexso",
            "value": 0
        },
        {
            "name": "Pydatajson",
            "value": 0
        },
        {
            "name": "R Library Numbers for Development",
            "value": 0
        },
        {
            "name": "SIMPLE-LAT",
            "value": 0
        },
        {
            "name": "SmartMap",
            "value": 0
        },
        {
            "name": "Tabula",
            "value": 0
        },
        {
            "name": "Textar",
            "value": 0
        },
        {
            "name": "Vota Inteligente",
            "value": 0
        }
    ],
    codeTrendAllTimeDivisions:[
        {
            "value" : 512,
            "name" : "Massive change detection",
            "divisionCodes" : "FMM"
        },
        {
            "value" : 360,
            "name" : "AP-LATAM",
            "divisionCodes" : "FMM"
        },
        {
            "value" : 1105,
            "name" : "SIMPLE-LAT",
            "divisionCodes" : "ICS"
        },
        {
            "value" : 875,
            "name" : "R Library Numbers for Development",
            "divisionCodes" : "ISU"
        },
        {
            "value" : 838,
            "name" : "IDBx Data Engine",
            "divisionCodes" : "KIC"
        },
        {
            "value" : 3633,
            "name" : "MapMap",
            "divisionCodes" : "KLD"
        },
        {
            "value" : 2726,
            "name" : "Consul",
            "divisionCodes" : "KLD"
        },
        {
            "value" : 861,
            "name" : "Tabula",
            "divisionCodes" : "KLD"
        },
        {
            "value" : 813,
            "name" : "Gobierto",
            "divisionCodes" : "KLD"
        },
        {
            "value" : 738,
            "name" : "AEDES Detector",
            "divisionCodes" : "KLD"
        },
        {
            "value" : 691,
            "name" : "Vota Inteligente",
            "divisionCodes" : "KLD"
        },
        {
            "value" : 593,
            "name" : "Textar",
            "divisionCodes" : "KLD"
        },
        {
            "value" : 559,
            "name" : "Gmapsdistance",
            "divisionCodes" : "KLD"
        },
        {
            "value" : 344,
            "name" : "Pydatajson",
            "divisionCodes" : "KLD"
        },
        {
            "value" : 1120,
            "name" : "SmartMap",
            "divisionCodes" : "MIF"
        },
        {
            "value" : 1051,
            "name" : "Nexso",
            "divisionCodes" : "MIF"
        },
        {
            "value" : 3881,
            "name" : "Indicator aggregator",
            "divisionCodes" : "SPD"
        },
        {
            "value" : 381,
            "name" : "Clasificador de Datos Atípicos",
            "divisionCodes" : "SPH"
        },
        {
            "value" : 4616,
            "name" : "Hydro-BID",
            "divisionCodes" : "WSA"
        },
        {
            "value" : 3280,
            "name" : "Evaluación de Reciclaje Inclusivo",
            "divisionCodes" : "WSA"
        }
    ],
    codeTrend2018Divisions:[
        {
            "name" : "Massive change detection",
            "divisionCodes" : "FMM",
            "value" : 495
        },
        {
            "name" : "AP-LATAM",
            "divisionCodes" : "FMM",
            "value" : 350
        },
        {
            "name" : "SIMPLE-LAT",
            "divisionCodes" : "ICS",
            "value" : 0
        },
        {
            "name" : "R Library Numbers for Development",
            "divisionCodes" : "ISU",
            "value" : 0
        },
        {
            "name" : "IDBx Data Engine",
            "divisionCodes" : "KIC",
            "value" : 0
        },
        {
            "name" : "Gobierto",
            "divisionCodes" : "KLD",
            "value" : 801
        },
        {
            "name" : "Gmapsdistance",
            "divisionCodes" : "KLD",
            "value" : 531
        },
        {
            "name" : "AEDES Detector",
            "divisionCodes" : "KLD",
            "value" : 0
        },
        {
            "name" : "Consul",
            "divisionCodes" : "KLD",
            "value" : 0
        },
        {
            "name" : "MapMap",
            "divisionCodes" : "KLD",
            "value" : 0
        },
        {
            "name" : "Pydatajson",
            "divisionCodes" : "KLD",
            "value" : 0
        },
        {
            "name" : "Tabula",
            "divisionCodes" : "KLD",
            "value" : 0
        },
        {
            "name" : "Textar",
            "divisionCodes" : "KLD",
            "value" : 0
        },
        {
            "name" : "Vota Inteligente",
            "divisionCodes" : "KLD",
            "value" : 0
        },
        {
            "name" : "Nexso",
            "divisionCodes" : "MIF",
            "value" : 0
        },
        {
            "name" : "SmartMap",
            "divisionCodes" : "MIF",
            "value" : 0
        },
        {
            "name" : "Indicator aggregator",
            "divisionCodes" : "SPD",
            "value" : 0
        },
        {
            "name" : "Clasificador de Datos Atípicos",
            "divisionCodes" : "SPH",
            "value" : 376
        },
        {
            "name" : "Evaluación de Reciclaje Inclusivo",
            "divisionCodes" : "WSA",
            "value" : 0
        },
        {
            "name" : "Hydro-BID",
            "divisionCodes" : "WSA",
            "value" : 0
        }
    ],
    codeTrendAllTimeDepartments:[
        {
            "name" : "SIMPLE-LAT",
            "departmentCodes" : "IFD",
            "value" : 1105
        },
        {
            "name" : "Massive change detection",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "IFD",
            "D" : 512
        },
        {
            "name" : "AP-LATAM",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "IFD",
            "D" : 360
        },
        {
            "name" : "Hydro-BID",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "INE",
            "D" : 4616
        },
        {
            "name" : "Evaluación de Reciclaje Inclusivo",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "INE",
            "D" : 3280
        },
        {
            "name" : "MapMap",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "KIC",
            "D" : 3633
        },
        {
            "name" : "Consul",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "KIC",
            "D" : 2726
        },
        {
            "name" : "R Library Numbers for Development",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "KIC",
            "D" : 875
        },
        {
            "name" : "Tabula",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "KIC",
            "D" : 861
        },
        {
            "name" : "IDBx Data Engine",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "KIC",
            "D" : 838
        },
        {
            "name" : "Gobierto",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "KIC",
            "D" : 813
        },
        {
            "name" : "AEDES Detector",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "KIC",
            "D" : 738
        },
        {
            "name" : "Vota Inteligente",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "KIC",
            "D" : 691
        },
        {
            "name" : "Textar",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "KIC",
            "D" : 593
        },
        {
            "name" : "Gmapsdistance",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "KIC",
            "D" : 559
        },
        {
            "name" : "Pydatajson",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "KIC",
            "D" : 344
        },
        {
            "name" : "SmartMap",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "MIF",
            "D" : 1120
        },
        {
            "name" : "Nexso",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "MIF",
            "D" : 1051
        },
        {
            "name" : "Clasificador de Datos Atípicos",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "SCL",
            "D" : 381
        },
        {
            "name" : "Indicator aggregator",
            "json_featuretype" : "Sheet 1",
            "departmentCodes" : "SPD",
            "D" : 3881
        }
    ],
    codeTrend2018Departments:[
        {
            "name" : "Massive change detection",
            "departmentCodes" : "IFD",
            "value" : 495
        },
        {
            "name" : "AP-LATAM",
            "departmentCodes" : "IFD",
            "value" : 350
        },
        {
            "name" : "SIMPLE-LAT",
            "departmentCodes" : "IFD",
            "value" : 0
        },
        {
            "name" : "Evaluación de Reciclaje Inclusivo",
            "departmentCodes" : "INE",
            "value" : 0
        },
        {
            "name" : "Hydro-BID",
            "departmentCodes" : "INE",
            "value" : 0
        },
        {
            "name" : "Gobierto",
            "departmentCodes" : "KIC",
            "value" : 801
        },
        {
            "name" : "Gmapsdistance",
            "departmentCodes" : "KIC",
            "value" : 531
        },
        {
            "name" : "AEDES Detector",
            "departmentCodes" : "KIC",
            "value" : 0
        },
        {
            "name" : "Consul",
            "departmentCodes" : "KIC",
            "value" : 0
        },
        {
            "name" : "IDBx Data Engine",
            "departmentCodes" : "KIC",
            "value" : 0
        },
        {
            "name" : "MapMap",
            "departmentCodes" : "KIC",
            "value" : 0
        },
        {
            "name" : "Pydatajson",
            "departmentCodes" : "KIC",
            "value" : 0
        },
        {
            "name" : "R Library Numbers for Development",
            "departmentCodes" : "KIC",
            "value" : 0
        },
        {
            "name" : "Tabula",
            "departmentCodes" : "KIC",
            "value" : 0
        },
        {
            "name" : "Textar",
            "departmentCodes" : "KIC",
            "value" : 0
        },
        {
            "name" : "Vota Inteligente",
            "departmentCodes" : "KIC",
            "value" : 0
        },
        {
            "name" : "Nexso",
            "departmentCodes" : "MIF",
            "value" : 0
        },
        {
            "name" : "SmartMap",
            "departmentCodes" : "MIF",
            "value" : 0
        },
        {
            "name" : "Clasificador de Datos Atípicos",
            "departmentCodes" : "SCL",
            "value" : 376
        },
        {
            "name" : "Indicator aggregator",
            "departmentCodes" : "SPD",
            "value" : 0
        }
    ]
}

//init
drawChartCodeTrend(codetrendArrays.codeTrendIADBAllTime);

//click radiobutton drawChart(id del click)
$("input[name*='codeTrend']").click(function () {
    d3.select("#code-trend svg").remove();
    drawChartCodeTrend(codetrendArrays[this.id]);
});

function drawChartCodeTrend(codeTrend) {

    dataCodeTrend = codeTrend.sort(function (a, b) {
        return d3.ascending(a.value, b.value);
    });

    var marginCodeTrend = {
        top: 15,
        right: 25,
        bottom: 15,
        left: 205
    };

    var widthCodeTrend = 520 - marginCodeTrend.left - marginCodeTrend.right,
        heightCodeTrend = 400 - marginCodeTrend.top - marginCodeTrend.bottom;


    var svgCodeTrend = d3.select("#code-trend").append("svg")
        .attr("width", widthCodeTrend + marginCodeTrend.left + marginCodeTrend.right)
        .attr("height", heightCodeTrend + marginCodeTrend.top + marginCodeTrend.bottom)
        .append("g")
        .attr("transform", "translate(" + marginCodeTrend.left + "," + marginCodeTrend.top + ")");

    var xCodeTrend = d3.scaleLinear()
        .range([0, widthCodeTrend])
        .domain([0, d3.max(dataCodeTrend, function (d) {
            return d.value;
        })]);

    var yCodeTrend = d3.scaleBand()
        .rangeRound([heightCodeTrend, 0], .1)
        .domain(dataCodeTrend.map(function (d) {
            return d.name;
        }));

    var yAxisCodeTrend = d3.axisLeft(yCodeTrend)
        //no tick marks
        .tickPadding(205)
        .tickSize(0);

    var gyCodeTrend = svgCodeTrend.append("g")
        .style("text-anchor", "start")
        .style("color", "#f0b600")
        .attr("class", "y-code")
        .call(yAxisCodeTrend)

    var barsCodeTrend = svgCodeTrend.selectAll(".bar")
        .data(dataCodeTrend)
        .enter()
        .append("g")

    barsCodeTrend.append("rect")
        .attr("class", "bar")
        .attr("y", function (d) {
            return yCodeTrend(d.name);
        })
        .attr("fill", "#d3d3d3")
        .attr("height", yCodeTrend.bandwidth() - 2)
        .attr("x", 8)
        .attr("width", function (d) {
            return xCodeTrend(d.value);
        });

    barsCodeTrend.append("text")
        .attr("class", "label")
        //y position of the label is halfway down the bar
        .attr("y", function (d) {
            return yCodeTrend(d.name) + yCodeTrend.bandwidth() / 2 + 4;
        })
        //x position is 3 pixels to the right of the bar
        .attr("x", function (d) {
            return 12;
        })
        .attr("class", "text-inside")
        .attr("font-family", "Gotham-Bold")
        .attr("font-size", "12px")
        .text(function (d) {
            return (d.value / 1000) + "K";
        });
}

/**
 * End code-trend
 *  
 * */

/**
 * Start tree
 *  */

var dataTree = {
    "name": "flare",
    "children": [{
        "name": "analytics",
        "children": [{
                "name": "graph",
                "children": [{
                    "name": "Google",
                    "size": 66
                }]
            },
            {
                "name": "optimization",
                "children": [{
                    "name": "IDB Publications",
                    "size": 18
                }]
            },{
                "name": "graph",
                "children": [{
                    "name": "Google",
                    "size": 66
                }]
            },
            {
                "name": "optimization",
                "children": [{
                    "name": "IDB Publications",
                    "size": 18
                }]
            },
            {
                "name": "optimization",
                "children": [{
                    "name": "AspectRatioBanker",
                    "children": [{
                        "children": [{
                            "name": "Others",
                            "size": 6
                        }, {
                            "name": "",
                            "size": 3
                        }],
                        "name": "Others"
                    }, {
                        "children": [{
                            "name": "IDB Blogs",
                            "size": 3
                        }, {
                            "name": "",
                            "size": 1
                        }, {
                            "name": "",
                            "size": 1
                        }, {
                            "name": "",
                            "size": 1
                        }, {
                            "name": "",
                            "size": 1
                        }, {
                            "name": "",
                            "size": 1
                        }],
                        "name": "IDB Blogs"
                    }]
                }]
            }
        ]
    }]
}

drawTree(dataTree);

function drawTree(dataTree) {
    const marginTree = {
            top: 40,
            right: 10,
            bottom: 10,
            left: 10
        },
        widthTree = 935 - marginTree.left - marginTree.right,
        heightTree = 200 - marginTree.top - marginTree.bottom,
        colorTree = d3.scaleOrdinal().range(["#ebb203", "#ebb817", "#edc959", "#f0e9eb", "#f1ede2", "#f1f1f1"]);

    const treemap = d3.treemap().size([widthTree, heightTree]);

    const divTree = d3.select("#downloads-code").append("div")
        .style("position", "relative")
        .style("width", (widthTree + marginTree.left + marginTree.right) + "px")
        .style("height", (heightTree + marginTree.top + marginTree.bottom) + "px")
        .style("left", marginTree.left + "px")
        .style("top", marginTree.top + "px");
    const root = d3.hierarchy(dataTree, (d) => d.children)
        .sum((d) => d.size);

    const tree = treemap(root);

    const node = divTree.datum(root).selectAll(".node")
        .data(tree.leaves())
        .enter().append("div")
        .attr("class", "node")
        .style("left", (d) => d.x0 + "px")
        .style("top", (d) => d.y0 + "px")
        .style("width", (d) => Math.max(0, d.x1 - d.x0) + "px")
        .style("height", (d) => Math.max(0, d.y1 - d.y0) + "px")
        .style("background", (d) => colorTree(d.parent.data.name))
        .text((d) => d.data.name);

    d3.selectAll("input").on("change", function change() {
        const value = this.value === "count" ?
            (d) => {
                return d.size ? 1 : 0;
            } :
            (d) => {
                return d.size;
            };

        const newRoot = d3.hierarchy(dataTree, (d) => d.children)
            .sum(value);

        node.data(treemap(newRoot).leaves())
            .transition()
            .duration(1500)
            .style("left", (d) => d.x0 + "px")
            .style("top", (d) => d.y0 + "px")
            .style("width", (d) => Math.max(0, d.x1 - d.x0 - 1) + "px")
            .style("height", (d) => Math.max(0, d.y1 - d.y0 - 1) + "px")
    });
}
/**
 * End tree
 *  */

 /**
 * Start timelines
 *  */
var dataTimeline = [{
    "date": "1-Jul-18",
    "close": 60000
},
{
    "date": "30-Apr-18",
    "close": 50000
},
{
    "date": "27-Jan-18",
    "close": 45000
},
{
    "date": "26-Dec-17",
    "close": 35000
},
{
    "date": "24-Jul-17",
    "close": 20000
},
{
    "date": "20-Dec-16",
    "close": 30000
}, {
    "date": "16-Jul-16",
    "close": 25000
},
{
    "date": "27-Mar-14",
    "close": 12000
},
{
    "date": "26-Jan-13",
    "close": 5000
}
]

createChartTimeline(dataTimeline);

function createChartTimeline(data) {
var margin = {
        top: 20,
        right: 20,
        bottom: 30,
        left: 50
    },
    width = 520 - margin.left - margin.right,
    height = 240 - margin.top - margin.bottom;

// parse the date / time
var parseTime = d3.timeParse("%d-%b-%y");

// set the ranges
var x = d3.scaleTime().range([0, width]);
var y = d3.scaleLinear().range([height, 0]);

// define the area
var area = d3.area()
    .x(function (d) {
        return x(d.date);
    })
    .y0(height)
    .y1(function (d) {
        return y(d.close);
    });

// define the line
var valueline = d3.line()
    .x(function (d) {
        return x(d.date);
    })
    .y(function (d) {
        return y(d.close);
    });

// append the svg obgect to the body of the page
// appends a 'group' element to 'svg'
// moves the 'group' element to the top left margin
var svg = d3.select("#timeline-code").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
var totalAmount = 0;
// format the data
data.forEach(function (d) {
    d.date = parseTime(d.date);
});

for (var i = 0; i < data.length; i++) {
    data[i].close = +data[i].close;
    totalAmount += data[i].close;
    if (i > 0) {
        data[i]['CumulativeAmount'] = data[i].close + data[i - 1].close;
    } else {
        data[i]['CumulativeAmount'] = data[i].close;
    }
}
//now calculate cumulative % from the cumulative amounts & total, round %
for (var i = 0; i < data.length; i++) {
    data[i]['CumulativePercentage'] = (data[i]['CumulativeAmount'] / totalAmount);
    data[i]['CumulativePercentage'] = parseFloat(data[i]['CumulativePercentage'].toFixed(2));
}

var lineGen = d3.line()
    .x(function (d) {
        return x(d.date);
    })
    .y(function (d) {
        return y(d.CumulativeAmount);
    });

// scale the range of the data
x.domain(d3.extent(data, function (d) {
    return d.date;
}));
y.domain([0, d3.max(data, function (d) {
    return d.close;
})]);

// add the area
svg.append("path")
    .data([data])
    .attr("class", "area")
    .attr("d", area);

// add the valueline path.
svg.append("path")
    .data([data])
    .attr("class", "line")
    .attr("d", valueline);
//
svg.append('svg:path')
    .attr('d', lineGen(data))
    .attr('stroke', '#c3c3c3')
    .attr("stroke-dasharray", "4")
    .attr('stroke-width', 2)
    .attr('fill', 'none');

// add the X Axis
svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .attr("class", "x-axis")
    .style('stroke-width', '3px')
    .style("font-family", "Gotham-Book")
    .style("font-size", "13px")
    .call(d3.axisBottom(x));

// add the Y Axis
svg.append("g")
    .attr("class", "y-axis")
    .style("font-family", "Gotham-Book")
    .style("font-size", "13px")
    .call(d3.axisLeft(y)
        .tickFormat(d3.format(".2s")));
}

/**
* End timelines
*  */